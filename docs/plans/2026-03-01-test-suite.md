# AgFrame 全量测试方案与执行计划

> **目标**：建立可重复执行的一套测试体系，覆盖单元测试、集成测试、功能测试、性能测试、安全测试与回归测试；并将覆盖率门禁固化为自动化命令与报告产物。

---

## 1. 测试范围

### 1.1 纳入覆盖率统计的代码范围（Coverage Scope）
- `./app/infrastructure/**`
- `./app/runtime/prompts/**`
- `./app/server/api/**`

### 1.2 不纳入覆盖率门禁但仍做冒烟/静态检查的范围（Excluded from coverage gate）
- 依赖外部服务或大模型/向量库的模块（如需要 Redis、PostgreSQL、LangChain 在线调用、模型下载/推理等）在本地无依赖环境下仅做导入级与接口冒烟，不作为覆盖率门禁指标来源

### 1.3 关键路径（100% 覆盖）
- Prompt 组装：`./app/runtime/prompts/prompt_builder.py`
- 认证与令牌：`./app/infrastructure/utils/security.py` + `./app/server/api/auth.py`
- 文件上传隔离：`./app/server/api/upload.py`

---

## 2. 测试目标
- 单元测试：覆盖核心纯逻辑/边界条件，确保关键函数行为稳定
- 集成测试：覆盖 FastAPI 路由 + 依赖注入 + DB（sqlite）交互链路
- 功能测试：以用户视角验证关键接口功能（注册/登录/健康检查/上传）
- 性能测试：对关键热点函数给出基准数据（p50/p95/吞吐）
- 安全测试：静态扫描 + 关键安全行为（口令哈希、JWT、路径隔离）
- 回归测试：将关键路径测试作为回归门禁，支持固定基线与差异对比

---

## 3. 用例设计原则
- 等价类 + 边界值优先（长度、空值、异常类型、超预算截断）
- 关注可观察输出（返回值/状态码/持久化结果），避免对内部实现细节过度耦合
- 依赖外部系统一律通过依赖注入/Mock 隔离（DB 用 sqlite、Redis 通过跳过生命周期或覆盖依赖）
- 对安全相关行为采用“负向优先”（非法 token、错误口令、非 PDF、路径穿越尝试）
- 对性能测试强调“稳定可重复”（固定数据规模、固定迭代次数、输出 JSON）

---

## 4. 测试环境配置

### 4.1 Conda 环境（必选）
- 使用 `./environment.yml` 创建与复现环境

### 4.2 运行环境变量（测试默认）
- `DATABASE_URL=sqlite+pysqlite:///:memory:`（集成测试使用）
- 其余配置沿用默认值，并在测试中通过依赖覆盖保证不触发外部依赖

---

## 5. 测试数据准备
- `./tests/fixtures/golden_cases.json` 作为固定评测/回归样本
- 生成型数据（随机用户名、临时文件）通过 pytest 临时目录与随机 UUID 生成，避免污染工作区

---

## 6. 测试执行流程
- 本地一键运行：`./scripts/run_test_suite.sh`
- 产物目录：`./reports/test_suite/<timestamp>/`
  - `pytest.json`：pytest 结构化结果
  - `coverage.xml`：覆盖率报告
  - `perf.json`：性能基准数据
  - `security.json`：安全扫描摘要（bandit/pip-audit）
  - `report.md`：汇总报告（含通过/失败判定）

---

## 7. 缺陷管理流程
- 缺陷记录格式：`./reports/test_suite/<timestamp>/defects.md`
- 字段：ID、标题、严重级别、范围、复现步骤、期望/实际、定位、修复建议、状态
- 严重级别：P0（阻断发布）/ P1（高）/ P2（中）/ P3（低）

---

## 8. 测试报告格式（核心章节）
- 概览（范围、版本、时间、环境）
- 执行结果（总数/通过/失败/跳过，失败用例列表）
- 覆盖率（总体与关键路径）
- 性能基准（指标与对比口径）
- 安全扫描（高危/中危/低危计数与样例）
- 缺陷清单（链接 defects.md）
- 改进建议（短期/中期）

---

## 9. 通过/失败判定标准
- 覆盖率门禁：Coverage Scope 总体行覆盖率 ≥ 80%
- 关键路径：关键路径文件在 Coverage Scope 中达到 100% 行覆盖
- 单测/集成/功能：全部测试用例通过（允许显式 skip：外部依赖缺失）
- 性能：产出基准数据；若启用回归对比则不得超过基线阈值（默认不启用门禁）
- 安全：bandit/pip-audit 结果写入报告；若存在高危项（High）则判定失败

